name:  Publish Dockerfile and Addon

on:
  workflow_dispatch:
  workflow_call:
    secrets:
      DOCKERHUB_USERNAME:
        required: true
      DOCKERHUB_TOKEN:
        required: true
      PAT:
        required: true
permissions:
  contents: write
jobs:
  publish:
    name: "Publish to Docker and Addon"
    runs-on: ubuntu-latest
    environment: release
    env:
      TAG_NAME: "declaration"
    steps:
      - name: Check out server
        uses: actions/checkout@v4
        with:
          path: 'server'
          token: ${{ secrets.PAT }}
      - name: Check out hassio-addon-repository
        uses: actions/checkout@v4
        with:
          path: 'hassio-addon-repository'
          repository: 'modbus2mqtt/hassio-addon-repository'
          token: ${{ secrets.PAT }}
      - name: Prepare Addon Directory
        id: prepareAddonDirectory
        run: |
         chmod +x ./server/docker/releaseAddon.py 
         ./server/docker/releaseAddon.py --release >>$GITHUB_ENV
      - name: Login to DockerHub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - uses: tyriis/docker-image-tag-exists@v2.1.0
        id: docker-image-exists
        with:
          registry: docker.io
          repository: modbus2mqtt-amd64
          tag: ${{env.TAG_NAME}}          
      - name: Publish
        if: steps.docker-image-exists.outputs.tag == 'found'
        uses: home-assistant/builder@master
        with:
          args: |
            --all \
            --target ./hassio-addon-repository/modbus2mqtt/ \
            --image modbus2mqtt-{arch} \
            --docker-hub modbus2mqtt
      - name: "✏️ Generate release changelog"
        uses: heinrichreimer/action-github-changelog-generator@v2.4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          output: hassio-addon-repository/modbus2mqtt/CHANGELOG.md
      - name: Checkin hassio-addon-repository
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          repository: ./hassio-addon-repository
          tagging_message: ${{env.TAG_NAME}}
          commit_message: ${{env.TAG_NAME}}
        
    

  
